import React, { useState } from 'react'
import { X, Lightbulb, Plus, Check, Trash2, ChevronDown, ChevronRight, Globe, Lock, Edit3 } from 'lucide-react'
import { EntryNode } from '@/pages/dashboard/constellation'
import { ConnectionData } from './ConnectionDrawer'

const VERDICT_ICONS: Record<string, { icon: string; color: string }> = {
  compelling: { icon: '✦', color: 'text-amber-400' },
  inconclusive: { icon: '◐', color: 'text-blue-400' },
  skeptical: { icon: '⊘', color: 'text-gray-400' },
  needs_info: { icon: '?', color: 'text-purple-400' },
}

export interface TheoryData {
  id: string
  title: string
  thesis: string
  entry_ids: string[]
  connection_ids: string[]
  is_public: boolean
  created_at: string
  updated_at: string
}

interface TheoryPanelProps {
  isOpen: boolean
  onClose: () => void
  theories: TheoryData[]
  entries: EntryNode[]
  connections: ConnectionData[]
  userToken: string
  onTheoryChanged: () => void
}

export default function TheoryPanel({
  isOpen,
  onClose,
  theories,
  entries,
  connections,
  userToken,
  onTheoryChanged,
}: TheoryPanelProps) {
  const [mode, setMode] = useState<'list' | 'create' | 'edit'>('list')
  const [editingTheory, setEditingTheory] = useState<TheoryData | null>(null)
  const [expandedId, setExpandedId] = useState<string | null>(null)

  // Form state
  const [title, setTitle] = useState('')
  const [thesis, setThesis] = useState('')
  const [selectedEntryIds, setSelectedEntryIds] = useState<string[]>([])
  const [selectedConnectionIds, setSelectedConnectionIds] = useState<string[]>([])
  const [isPublic, setIsPublic] = useState(false)
  const [saving, setSaving]͕̀Mхє͔((=ɕɸձ((Ёɕ͕ɴ􀠤(͕Qѱ(͕Q̠ͥ(͕Mѕ%̡mt(͕Mѕѥ%̡mt(͕%AՉ͔(͕ѥQ䡹ձ(((ЁхЀѡQф(͕Qѱѡѥѱ(͕Q̡ͥѡѡ̤ͥ(͕Mѕ%̡ѡ乕}̤(͕Mѕѥ%̡ѡ乍ѥ}̤(͕%AՉѡ乥}Չ(͕ѥQѡ(͕5М(((ЁMٔ幌(ѥѱɥɕɸ(͕M٥Ք((Ёѡ􁵽􀝕МAUP耝A=MP(Ё聅(ѥѱ(ѡ̰ͥ(}͕ѕ%̰(ѥ}͕ѕѥ%̰(}Չ聥AՉ((􀝕МѥQ䤁(ѡ}􁕑ѥQ乥(((Ёɕ݅Ёэѕѥѡɥ̜(ѡ((ѕеQ耝ѥͽ(ѡɥѥ聁	ɕȀ͕Q(()M=8ɥ䡉䤰((ɕ(Q(ɕ͕ɴ(͕5М((􁙥(͕M٥͔((((Ёє幌ѡ%ɥ(Ёɕ݅Ёэѕѥѡɥ̜(ѡ耝1Q((ѕеQ耝ѥͽ(ѡɥѥ聁	ɕȀ͕Q(()M=8ɥѡ}ѡ%((ɕQ(((Ёѽ􀡥ɥ(͕Mѕ%̡ɕ؀(ɕعՑ̡ɕعѕȡ􁥐lɕذt((((Ёѽѥ􀡥ɥ(͕Mѕѥ%̡ɕ؀(ɕعՑ̡ɕعѕȡ􁥐lɕذt((((ɕɸ(؁9􉙥ᕐ͕дѕ̵ѕȁѥ䵍ѕȁɽȵʹ(؁9􉉜ɅɑȁɑȵɅɽչᰁܵձܴᰁЁൠl١t്(켨!Ȁ(؁9􉙱ѕ̵ѕȁѥ䵉ݕЁɑȵɑȵɅ(؁9􉙱ѕ̵ѕȁȈ(1щձ9ܴԁԁѕеȴ(ȁ9ѕеݡєе͕(􀝱МeȁQɥ̜聵􀝍ɕє9܁Q䜀耝ЁQ((􀝱М(9ѕеɅѕеʹѡɥ̹ѡ((𽑥(ѽ젤ɕ͕ɴ͕5М쁽͔􁍱9ѕеɅٕѕеݡє(`9ܴԁԈ(ѽ(𽑥((켨ѕЀ(؁9􉙱āٕəܵ䵅ѼЈ(􀝱М((ѡɥ̹Ѡ(؁9ѕеѕȁ(1щձ9شѕеɅ൅Ѽ̈(9ѕеɅѕеʹĈ9ѡɥ́(9ѕеɅѕе́Ј(Qɥ́ɔѥ́ѕɥ́ݥѠɥѕѡ̸ͥ((𽑥(耠(؁9̈(ѡɥ̹ѡ(Ё%ѡ乥(Ёѡɥ̀􁕹ɥ̹ѕȡѡ乕}̹Ց̡(ɕɸ(؁ѡ乥􁍱9􉉜ɅɑȁɑȵɅɽչᰁٕəܵ(ѽ(젤͕%ձѡ乥(9ܵձѕ̵хЁ́ЁѕеЁٕ鉜ɅɅͥѥ̈(((ɽݸ9ܴЁЁѕеɅ͡ɥдԈ(耠(ɽIЁ9ܴЁЁѕеɅ͡ɥдԈ((؁9􉙱āܷ#Fb674S&fWFV26VFW"v"#7674S'FWBvFRfBVFVFWB6#FV'FFW7FV'5V&Ɩ2v&R674S'r22FWBw&VVC"6674S'r22FWBw&S"ТFcFb674S'FWBw&SFWBׇ2BR#FV'VG'G2VwFVG&W2+rFV'6V7FG2VwF6V7F0FcFc'WGFࠢ4WFVBbbFb674S'B"BB#FV'FW62bb674S'FWBw&3FWB6"2r#FV'FW67ТFV'VG&W2VwFbbFb674S'r"2#Fb674S'FWBׇ2FWBw&S"R#7W'FrVG&W3FcFb674S'76Rג#FV'VG&W26Ɩ6RRR67BbdU$D5E45RfW&F7EdU$D5E42VVG5f&WGW&FbW׶RG674S&fWFV26VFW"v"FWBׇ2#7674S׷b6'b677674S'FWBw&3G'V6FR#RW7FcҗТFV'VG&W2VwFRbbFb674S'FWBׇ2FWBw&S#ⷷFV'VG&W2VwFW&SFcТFcFcТFb674S&fWv"r#'WGF6Ɩ6ײ7F'DVFBFV'Т674S&fWFV26VFW"vR2RFWBׇ2&rw&sfW#&rw&cFWBw&3&VFVBrG&6F6'2 VFC2674S'r22"VF@'WGF'WGF6Ɩ6ײFTFVWFRFV'BТ674S&fWFV26VFW"vR2RFWBׇ2&rw&sfW#&r&VBӓSFWBw&CfW#FWB&VBC&VFVBrG&6F6'2 G&6"674S'r22"FVWFP'WGFFcFcТFcҗТFcТРFRv7&VFRrFRvVFBrbbFb674S'76RגB#FFRТFc&V674S'FWBw&CFWBׇ2fBVFV&6"#FV'S&VƖW@GS'FWB fVS׷FFWТ6vS׶R6WEFFRRF&vWBfVRТ6VFW#vRr$֖ƗF'&֗GFW62"p674S'rgV&rw&Ӄ&&FW"&&FW"w&s&VFVBr2"FWB6FWBvFR6VFW"w&Sf7W3WFƖRRf7W3&&FW"&'S WFf7W0FcࠢFW62ТFc&V674S'FWBw&CFWBׇ2fBVFV&6"#FW63&VFWF&VfVS׷FW67Т6vS׶R6WEFW62RF&vWBfVRТ6VFW#$WFRGFW&RwfR'6W'fVBBW"FW62 &w3׳GТ674S'rgV&rw&Ӄ&&FW"&&FW"w&s&VFVBr2"FWB6FWBvFR6VFW"w&S&W6RRf7W3WFƖRRf7W3&&FW"&'S Fcࠢ6VV7BVG&W2ТFc&V674S'FWBw&CFWBׇ2fBVFV&6""#7W'FrVG&W26VV7FVDVG'G2VwF6VV7FVB&VFb674S&ւCfW&frגWF76Rג&rw&Ӄ3&VFVBr"#VG&W2VG'67B56VV7FVB6VV7FVDVG'G26VFW2VG'B67BbdU$D5E45VG'fW&F7EdU$D5E42VVG5f&WGW&'WGFW׶VG'GТ6Ɩ6ײFvvTVG'VG'BТ674S׶rgVfWFV26VFW"v""R&VFVBFWBVgBFWBׇ2G&6F6'2G56VV7FV@v&r&'SR&&FW"&&FW"&'S3pvfW#&rw&Ӄ&&FW"&&FW"G&7&VBpТFb674S׶rBB&VFVB&&FW"fWFV26VFW"W7Fg6VFW"6&G56VV7FVBv&r&'S&&FW"&'Srv&&FW"w&cp56VV7FVBbb6V6674S'r22FWBvFR"ТFc7674S׷b6'b677674S'FWBw&3G'V6FR#VG'W7'WGFҗТFcFcࠢ6VV7B6V7F2Т6V7F2VwFbbFc&V674S'FWBw&CFWBׇ2fBVFV&6""#&VFVB6V7F26VV7FVD6V7FG2VwF6VV7FVB&VFb674S&ւ3"fW&frגWF76Rג&rw&Ӄ3&VFVBr"#6V7F2667B56VV7FVB6VV7FVD6V7FG26VFW26B67BVG&W2fBRRB6VG'B67B"VG&W2fBRRB6VG'$Bb"&WGW&V&WGW&'WGFW׶6GТ6Ɩ6ײFvvT6V7F6BТ674S׶rgVfWFV26VFW"v""R&VFVBFWBVgBFWBׇ2G&6F6'2G56VV7FV@v&r7SR&&FW"&&FW"7S3pvfW#&rw&Ӄ&&FW"&&FW"G&7&VBpТFb674S׶rBB&VFVB&&FW"fWFV26VFW"W7Fg6VFW"6&G56VV7FVBv&r7S&&FW"7Srv&&FW"w&cp56VV7FVBbb6V6674S'r22FWBvFR"ТFc7674S'FWBw&3G'V6FR#W(i""W7'WGFҗТFcFcРV&Ɩ2FvvRТFb674S&fWFV26VFW"v2#'WGF6Ɩ6ײ6WD5V&Ɩ25V&Ɩ2Т674S׶&VFfRrR&VFVBgVG&6F6'2G5V&Ɩ2v&rw&VVSrv&rw&sТFb674S׶'6WFRFRrBB&VFVBgV&rvFRG&6FG&6f&G5V&Ɩ2wG&6FRׂRrwG&6FRׂRw'WGFFb674S&fWFV26VFW"vR#5V&Ɩ2v&R674S'r2R2RFWBw&VVC"6674S'r2R2RFWBw&S"Т7674S'FWB6FWBw&C#綗5V&Ɩ2uf6&RV&Ɩ2&fRru&fFRw7FcFcFcТFcࠢfFW"ТFb674S'B&&FW"B&&FW"w&ӃfWFV26VFW"W7Fg&WGvVV#FRvƗ7BrFb'WGF6Ɩ6ײ&W6WDf&҂6WDFRv7&VFRrТF6&VC׶VG&W2VwFТ674S&fWFV26VFW"v"B"&r&W"cfW#&r&W"SF6&VC6GSFWBvFR&VFVBrFWB6fBVFVG&6F6'2 W2674S'rBB"WrFV''WGF'WGF6Ɩ6ײ&W6WDf&҂6WDFRvƗ7BrТ674S'FWB6FWBw&CfW#FWBvFRG&6F6'2 (i&6FƗ7@'WGF'WGF6Ɩ6׶FU6fWТF6&VC׷6frFFRG&҂Т674S&fWFV26VFW"v"B"&r&W"cfW#&r&W"SF6&VC6GSFWBvFR&VFVBrFWB6fBVFVG&6F6'2 6V6674S'rBB"6fru6frrFRvVFBruWFFRFV'rt7&VFRFV'wТ'WGFТFcFcFc                                                                                                                                             b `WGW&Fb674S&fVB6WBSfWFV26VFW"W7Fg6VFW"&r&6c&6G&&W"6#FcЧР